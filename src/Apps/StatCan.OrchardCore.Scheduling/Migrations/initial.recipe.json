{
  "steps": [
    {
      "name": "ContentDefinition",
      "ContentTypes": [
        {
          "Name": "Appointment",
          "DisplayName": "Appointment",
          "Settings": {
            "ContentTypeSettings": {
              "Creatable": true,
              "Listable": true,
              "Securable": true
            },
            "FullTextAspectSettings": {}
          },
          "ContentTypePartDefinitionRecords": [
            {
              "PartName": "Appointment",
              "Name": "Appointment",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "1"
                }
              }
            },
            {
              "PartName": "TitlePart",
              "Name": "TitlePart",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "0"
                },
                "TitlePartSettings": {
                  "Options": 1,
                  "Pattern": "{% assign employee = ContentItem.Content.Appointment.LinkedContent.ContentItemIds | content_item_id | first %}\r\n{{employee.Content.Employee.FirstName.Text }} {{employee.Content.Employee.LastName.Text }}; {{ContentItem.Content.Appointment.StartDate.Value | local | date: \"%D %R\"}} - {{ContentItem.Content.Appointment.EndDate.Value | local | date: \"%R\" }}; {{ employee.Content.Employee.Cohort | taxonomy_terms | first | display_text}}",
                  "RenderTitle": false
                },
                "ContentIndexSettings": {}
              }
            }
          ]
        },
        {
          "Name": "AppointmentCalendar",
          "DisplayName": "AppointmentCalendar",
          "Settings": {
            "ContentTypeSettings": {
              "Securable": true
            },
            "FullTextAspectSettings": {}
          },
          "ContentTypePartDefinitionRecords": [
            {
              "PartName": "AppointmentCalendar",
              "Name": "AppointmentCalendar",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "1"
                }
              }
            },
            {
              "PartName": "TitlePart",
              "Name": "TitlePart",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "0"
                }
              }
            },
            {
              "PartName": "AutoroutePart",
              "Name": "AutoroutePart",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "2"
                },
                "AutoroutePartSettings": {
                  "ManageContainedItemRoutes": true,
                  "ShowHomepageOption": true
                },
                "ContentIndexSettings": {}
              }
            }
          ]
        },
        {
          "Name": "Employee",
          "DisplayName": "Employee",
          "Settings": {
            "ContentTypeSettings": {
              "Creatable": true,
              "Listable": true,
              "Securable": true
            },
            "FullTextAspectSettings": {}
          },
          "ContentTypePartDefinitionRecords": [
            {
              "PartName": "Employee",
              "Name": "Employee",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "1"
                }
              }
            },
            {
              "PartName": "TitlePart",
              "Name": "TitlePart",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "0"
                },
                "TitlePartSettings": {
                  "Options": 1,
                  "Pattern": "{{ContentItem.Content.Employee.FirstName.Text}} {{ContentItem.Content.Employee.LastName.Text}} - {{ContentItem.Content.Employee.Cohort | taxonomy_terms | first | display_text}}"
                },
                "ContentIndexSettings": {}
              }
            }
          ]
        },
        {
          "Name": "AppointmentPrint",
          "DisplayName": "Appointment Print",
          "Settings": {
            "ContentTypeSettings": {
              "Stereotype": "Widget"
            },
            "FullTextAspectSettings": {}
          },
          "ContentTypePartDefinitionRecords": [
            {
              "PartName": "AppointmentPrint",
              "Name": "AppointmentPrint",
              "Settings": {
                "ContentTypePartSettings": {
                  "Position": "0"
                }
              }
            }
          ]
        }
      ],
      "ContentParts": [
        {
          "Name": "Appointment",
          "Settings": {},
          "ContentPartFieldDefinitionRecords": [
            {
              "FieldName": "TaxonomyField",
              "Name": "Calendar",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Calendar",
                  "Position": "2"
                },
                "TaxonomyFieldSettings": {
                  "TaxonomyContentItemId": "4wnw5cysybe8szzhehezz5b74b",
                  "Unique": true
                }
              }
            },
            {
              "FieldName": "TextField",
              "Name": "Status",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Status",
                  "Editor": "PredefinedList",
                  "Position": "5"
                },
                "TextFieldSettings": {},
                "TextFieldPredefinedListEditorSettings": {
                  "Options": [
                    {
                      "name": "Upcoming",
                      "value": "UPCOMING"
                    },
                    {
                      "name": "Cancelled",
                      "value": "CANCELLED"
                    },
                    {
                      "name": "Completed",
                      "value": "COMPLETED"
                    },
                    {
                      "name": "No show",
                      "value": "NOSHOW"
                    }
                  ],
                  "DefaultValue": "UPCOMING"
                },
                "ContentIndexSettings": {}
              }
            },
            {
              "FieldName": "TextField",
              "Name": "Comments",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Comments",
                  "Editor": "TextArea",
                  "Position": "6"
                },
                "TextFieldSettings": {
                  "Hint": "These comments are visible to every other scheduler"
                },
                "ContentIndexSettings": {}
              }
            },
            {
              "FieldName": "ContentPickerField",
              "Name": "LinkedContent",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Linked Content",
                  "Position": "4"
                },
                "ContentPickerFieldSettings": {
                  "Multiple": false,
                  "DisplayedContentTypes": [
                    "Employee"
                  ]
                },
                "ContentIndexSettings": {}
              }
            },
            {
              "FieldName": "DateTimeField",
              "Name": "StartDate",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Start Date",
                  "Position": "0"
                }
              }
            },
            {
              "FieldName": "DateTimeField",
              "Name": "EndDate",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "End Date",
                  "Position": "1"
                }
              }
            },
            {
              "FieldName": "TextField",
              "Name": "Color",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Color",
                  "Editor": "Color",
                  "Position": "3"
                },
                "TextFieldSettings": {},
                "ContentIndexSettings": {}
              }
            }
          ]
        },
        {
          "Name": "AppointmentCalendar",
          "Settings": {},
          "ContentPartFieldDefinitionRecords": [
            {
              "FieldName": "TextField",
              "Name": "Color",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Color",
                  "Editor": "Color",
                  "Position": "2"
                },
                "TextFieldSettings": {}
              }
            }
          ]
        },
        {
          "Name": "Employee",
          "Settings": {},
          "ContentPartFieldDefinitionRecords": [
            {
              "FieldName": "TextField",
              "Name": "FirstName",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "FirstName",
                  "Position": "2"
                }
              }
            },
            {
              "FieldName": "TextField",
              "Name": "LastName",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Last Name",
                  "Position": "3"
                }
              }
            },
            {
              "FieldName": "BooleanField",
              "Name": "Consent",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Consent",
                  "Position": "5"
                },
                "BooleanFieldSettings": {
                  "Hint": "Consent form has been signed by the employee"
                },
                "ContentIndexSettings": {}
              }
            },
            {
              "FieldName": "BooleanField",
              "Name": "Participating",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Participating",
                  "Position": "4"
                },
                "BooleanFieldSettings": {
                  "Hint": "The employee is participating in the testing"
                }
              }
            },
            {
              "FieldName": "TaxonomyField",
              "Name": "Cohort",
              "Settings": {
                "ContentPartFieldSettings": {
                  "DisplayName": "Cohort",
                  "Position": "0"
                },
                "TaxonomyFieldSettings": {
                  "TaxonomyContentItemId": "4wnw5cysybe8szzhehezz5b74b",
                  "Unique": true
                }
              }
            }
          ]
        }
      ]
    },
    {
      "name": "content",
      "data": [
        {
          "ContentItemId": "4wnw5cysybe8szzhehezz5b74b",
          "ContentItemVersionId": "42p43tpp922cn31wpfadcwxtn1",
          "ContentType": "Taxonomy",
          "DisplayText": "Calendars",
          "Latest": true,
          "Published": true,
          "ModifiedUtc": "2021-05-18T17:22:49.2243686Z",
          "PublishedUtc": "2021-05-18T17:22:49.2316346Z",
          "CreatedUtc": "2021-05-18T17:04:12.2054281Z",
          "TitlePart": {
            "Title": "Calendars"
          },
          "AliasPart": {
            "Alias": "calendars"
          },
          "AutoroutePart": {
            "Path": "calendars",
            "SetHomepage": false,
            "Disabled": false,
            "RouteContainedItems": true,
            "Absolute": false
          },
          "TaxonomyPart": {
            "Terms": [
            ],
            "TermContentType": "AppointmentCalendar"
          }
        },
        {
          "ContentItemId": "4gbw4m0mz1sh45v9f2ztznktnw",
          "ContentItemVersionId": "41eytr03g1z67zp0d627pr4b58",
          "ContentType": "VueForm",
          "DisplayText": "Create appointment ",
          "Latest": true,
          "Published": true,
          "ModifiedUtc": "2021-05-18T17:49:36.4072455Z",
          "PublishedUtc": "2021-05-18T17:49:36.4138456Z",
          "CreatedUtc": "2021-04-16T01:52:41.1799908Z",
          "Owner": null,
          "Author": "admin",
          "TitlePart": {
            "Title": "Create appointment "
          },
          "VueForm": {
            "Enabled": {
              "Value": true
            },
            "RenderAs": {
              "Text": null
            },
            "DisabledHtml": {
              "Html": ""
            },
            "SuccessMessage": {
              "Text": "Your appointment was created successfully."
            }
          },
          "FlowPart": {
            "Widgets": [
              {
                "ContentItemId": "4a3hpsgsjkv2y1essvr0zp26c4",
                "ContentItemVersionId": null,
                "ContentType": "VueComponent",
                "DisplayText": "Form to create the appointment from the Calendar",
                "Latest": false,
                "Published": false,
                "ModifiedUtc": "2021-05-18T17:49:36.4093653Z",
                "PublishedUtc": null,
                "CreatedUtc": null,
                "Owner": "",
                "Author": "admin",
                "TitlePart": {
                  "Title": "Form to create the appointment from the Calendar"
                },
                "VueComponent": {
                  "Template": {
                    "Text": "<v-card >\r\n  <v-card-title>{{ \"formTitle\" | localize }} {{Model.CalendarTitle}}</v-card-title>\r\n  <v-card-subtitle>\r\n    {% raw %}{{ startDate }}{% endraw %}<br>\r\n    10 minutes\r\n  </v-card-subtitle>\r\n  <v-card-text>\r\n    <v-row>\r\n      <v-col>\r\n        <validation-provider name=\"{{ \"employeeLabel\" | localize | downcase }}\" rules=\"required\" v-slot=\"{ errors, valid }\">\r\n          <v-autocomplete v-model=\"employee\" :items=\"employeeList\" item-text=\"DisplayText\" item-value=\"ContentItemId\" label=\"{{ \"employeeLabel\" | localize }}\" :success=\"valid\" :error-messages=\"errors\"></v-autocomplete>\r\n        </validation-provider>\r\n      </v-col>      \r\n    </v-row>\r\n    <v-alert type=\"success\" v-if=\"form.successMessage\">\r\n      {% raw %}{{ form.successMessage }}{% endraw %}\r\n    </v-alert>\r\n    <v-alert type=\"error\" v-if=\"form.serverValidationMessage\">\r\n      {% raw %}{{ form.serverValidationMessage[0] }}{% endraw %}\r\n    </v-alert>\r\n  </v-card-text>\r\n  <v-card-actions>\r\n    <v-btn\r\n           text\r\n           color=\"secondary\"\r\n           @click=\"close\"\r\n     >\r\n      {{ \"closeButton\" | localize }}\r\n    </v-btn>\r\n    <v-spacer></v-spacer>\r\n    <v-btn text color=\"primary\" type=\"submit\" @click=\"loadDataAndSubmit\" :disabled=\"form.submitting\">{{ \"buttonText\" | localize }}</v-btn>\r\n  </v-card-actions>\r\n</v-card>"
                  }
                },
                "FlowMetadata": {
                  "Alignment": 3,
                  "Size": 100
                }
              }
            ]
          },
          "VueFormScripts": {
            "ClientInit": {
              "Text": null
            },
            "ComponentOptions": {
              "Text": "{\r\n  data: () => ({\r\n      startDate: new Date(),\r\n      endDate: new Date(),\r\n      employee: \"\",\r\n      employeeList: {{Model.Employees | json | raw}}\r\n  }),\r\n  mounted() {\r\n    const self = this;\r\n    this.startDate = window.startDate;\r\n    this.endDate = window.endDate;\r\n    // comes from the Calendar \r\n    window.addEventListener('create_appointment', e => {\r\n      self.employee = \"\";\r\n      self.startDate = window.startDate;\r\n      self.endDate = window.endDate;\r\n    })\r\n  },\r\n  methods: {\r\n    close() {\r\n      let event = new CustomEvent('close_appointment_dialog');\r\n      window.dispatchEvent(event);\r\n    },\r\n    submitData() {\r\n      return { \r\n        returnUrl: \"{{Model.CurrentUrl}}\",\r\n        startDate: this.startDate.toUTCString(),\r\n       \tendDate: this.endDate.toUTCString(),\r\n        employee: this.employee,\r\n       };\r\n    },\r\n    loadDataAndSubmit(e){\r\n      e.preventDefault();\r\n      this.formHandleSubmit(e)      \r\n    }\r\n    \r\n  }\r\n}"
            },
            "OnValidation": {
              "Text": null
            },
            "OnSubmitted": {
              "Text": "var localizedText = getLocalizedTextValues(getFormContentItem());\r\nvar data = requestFormAsJsonObject();\r\nvar employee = contentByItemId(data.employee);\r\nvar calendar = taxonomyTermsJobject(employee.Content.Employee.Cohort);\r\n\r\nvar color = \"#000000\"\r\nif(calendar != null)\r\n{\r\n  color = calendar[0].Content.AppointmentCalendar.Color.Text;\r\n}\r\n\r\nvar item = createContentItem(\"Appointment\", true, {\r\n  \"Appointment\": {\r\n    \"Calendar\": employee.Content.Employee.Cohort,\r\n    \"Status\": {\r\n      \"Text\": \"UPCOMING\"\r\n    },\r\n    \"LinkedContent\": {\r\n      \"ContentItemIds\": [\r\n        data.employee\r\n      ]\r\n    },\r\n    \"StartDate\": {\r\n      \"Value\": data.startDate\r\n    },\r\n    \"EndDate\": {\r\n      \"Value\": data.endDate\r\n    },\r\n    \"Color\": {\r\n      \"Text\": color\r\n    }\r\n  }\r\n});\r\nnotify(\"Success\", localizedText.successMessage);\r\n\r\nhttpRedirect(data.returnUrl)\r\n"
            }
          },
          "ContentPermissionsPart": {
            "Roles": [
              "Administrator",
              "Scheduler"
            ],
            "Enabled": true
          },
          "LocalizedTextPart": {
            "Data": [
              {
                "Name": "formTitle",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": "Créer un rendez-vous pour"
                  },
                  {
                    "Culture": "en",
                    "Value": "Create Appointment for"
                  }
                ]
              },
              {
                "Name": "buttonText",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": "Créer un rendez-vous"
                  },
                  {
                    "Culture": "en",
                    "Value": "Create Appointment"
                  }
                ]
              },
              {
                "Name": "employeeLabel",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": "Employé"
                  },
                  {
                    "Culture": "en",
                    "Value": "Employee"
                  }
                ]
              },
              {
                "Name": "",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": ""
                  },
                  {
                    "Culture": "en",
                    "Value": ""
                  }
                ]
              },
              {
                "Name": "successMessage",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": "Vôtre rendez-vous a été crée avec succès"
                  },
                  {
                    "Culture": "en",
                    "Value": "Your appointment has been successfully created"
                  }
                ]
              },
              {
                "Name": "closeButton",
                "LocalizedItems": [
                  {
                    "Culture": "fr",
                    "Value": "Annuler"
                  },
                  {
                    "Culture": "en",
                    "Value": "Cancel"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Queries",
      "Queries": [
        {
          "Template": "SELECT DocumentId FROM ContentItemIndex where ContentType = 'Appointment' and Published = true",
          "ReturnDocuments": true,
          "Name": "AllAppointments",
          "Source": "Sql",
          "Schema": null
        },
        {
          "Template": "SELECT DocumentId FROM ContentItemIndex where ContentType = 'Employee' and Published = true and Latest = true",
          "ReturnDocuments": true,
          "Name": "AllEmployees",
          "Source": "Sql",
          "Schema": null
        },
        {
          "Template": "SELECT DocumentId \r\nFROM AppointmentIndex\r\nWHERE AppointmentIndex.ContentItemId IN\r\n  (SELECT ContentItemId FROM TaxonomyIndex where ContentType = 'Appointment' and TermContentItemId in ({{calendarIds}})) \r\nAND StartDate BETWEEN '{{ startDate }}' AND '{{ endDate }}'\r\nORDER BY StartDate ASC",
          "ReturnDocuments": true,
          "Name": "AppointmentsForCalendarsForDate",
          "Source": "Sql",
          "Schema": null
        },
        {
          "Template": "query DataExport {\r\n  appointments: appointment {\r\n    contentItemId\r\n    contentItemVersionId\r\n    author\r\n    color\r\n    comments\r\n    modifiedUtc\r\n    startDate\r\n    endDate\r\n    status\r\n    linkedContent {\r\n      contentItemIds\r\n    }\r\n    calendar {\r\n      termContentItems {\r\n        ... on AppointmentCalendar {\r\n          displayText\r\n          contentItemId\r\n        }\r\n      }\r\n    }\r\n  }\r\n  employees: employee {\r\n    contentItemId\r\n    firstName\r\n    lastName\r\n    participating\r\n    consent\r\n    createdUtc\r\n    cohort {\r\n      termContentItems {\r\n        contentItemId\r\n        ... on AppointmentCalendar {\r\n          createdUtc\r\n          color\r\n          displayText\r\n        }\r\n      }\r\n    }\r\n  }\r\n}",
          "Name": "DataExport",
          "Source": "GraphQL",
          "Schema": null
        },
        {
          "Template": "SELECT DocumentId FROM TaxonomyIndex where ContentType = 'Employee' and TermContentItemId in ({{calendarIds}})",
          "ReturnDocuments": true,
          "Name": "EmployeesForCalendars",
          "Source": "Sql",
          "Schema": null
        },
        {
          "Template": "SELECT DocumentId FROM TaxonomyIndex where ContentType = 'Appointment' and TermContentItemId in ({{calendarIds}})",
          "ReturnDocuments": true,
          "Name": "AppointmentForCalendars",
          "Source": "Sql",
          "Schema": null
        }
      ]
    }
  ]
}
